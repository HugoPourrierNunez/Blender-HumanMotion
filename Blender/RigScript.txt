import bpy
from bpy_extras import view3d_utils

class CustomPanel(bpy.types.Panel):
    
    bl_label = "Auto Rigify"
    bl_space_type = 'VIEW_3D'
    bl_region_type = 'TOOLS'

    def draw(self, context):
        
        self.layout.operator("rig.positionview")
        self.layout.operator("rig.placebalise")
        self.layout.operator("rig.generaterig")


bpy.utils.register_class(CustomPanel)

class RIG_OT_positionview(bpy.types.Operator):
    bl_idname = "rig.positionview"
    bl_label = "Position View"
 
    def execute(self, context):
        positionView()
        return{'FINISHED'}    
 
#    Registration
bpy.utils.register_class(RIG_OT_positionview)

class RIG_OT_placebalise(bpy.types.Operator):
    bl_idname = "rig.placebalise"
    bl_label = "Place balises"
 
    def execute(self, context):
        placerBalise()
        return{'FINISHED'}    
 
#    Registration
bpy.utils.register_class(RIG_OT_placebalise)

class RIG_OT_generaterig(bpy.types.Operator):
    bl_idname = "rig.generaterig"
    bl_label = "Generate rig"
 
    def execute(self, context):
        createArmature((0,0,0), .1)
        return{'FINISHED'}    
 
#    Registration
bpy.utils.register_class(RIG_OT_generaterig)

class ModalOperator(bpy.types.Operator):
    bl_idname = "object.modal_operator"
    bl_label = "Simple Modal Operator"
    
    nbBalises = 7
    nbPlacer = 0
    
    names = ["topHead", "neckBase", "pelvis", "leftHand", "rightHand", "leftFeet", "rightFeet"]
    
    def placerRepere(self):
        bpy.ops.mesh.primitive_uv_sphere_add(size=.1, location=(0, 0, 0))
        bpy.context.selected_objects[0].name=self.names[self.nbPlacer]

    def __init__(self):
        print("Start")
        self.placerRepere()

    def __del__(self):
        #placerBalise()
        print("End")

    def execute(self, context):
        for area in bpy.context.screen.areas:
            if area.type == 'VIEW_3D':
                for region in area.regions:
                    if region.type == 'WINDOW':
                        override = {'area': area, 'region': region, 'edit_object': bpy.context.edit_object}
                        event = self.event
                        rv3d = area.spaces[0].region_3d
                        coord = event.mouse_region_x, event.mouse_region_y

                        # get the ray from the viewport and mouse
                        ray_origin = view3d_utils.region_2d_to_origin_3d(region, rv3d, coord)
                        context.object.location.y = ray_origin.y
                        context.object.location.z = ray_origin.z
        

    def modal(self, context, event):
        if event.type == 'MOUSEMOVE':  # Apply
            self.event = event
            self.execute(context)
        elif event.type == 'LEFTMOUSE' and event.value == 'RELEASE':  # Confirm
            self.nbPlacer+=1
            if self.nbPlacer == self.nbBalises:
                return {'FINISHED'}
            else:
                self.placerRepere()
        elif event.type in ( 'ESC'):  # Cancel
            return {'CANCELLED'}

        return {'RUNNING_MODAL'}

    def invoke(self, context, event):
        self.event = event
        self.execute(context)

        print(context.window_manager.modal_handler_add(self))
        return {'RUNNING_MODAL'}


bpy.utils.register_class(ModalOperator)


def createArmature(origin, coef):
    
    #bpy.ops.object.mode_set(mode='OBJECT')
    bpy.ops.object.select_all(action='SELECT')
    bpy.ops.object.delete(use_global=False)
    
    
    # Create armature and object
    #bpy.ops.object.mode_set(mode='OBJECT')
    
    amt = bpy.data.armatures.new('arm')
    rig = bpy.data.objects.new('rig', amt)
    edit_bones={}
    rig.location = origin
    rig.show_x_ray = True
    amt.show_names = True
    # Link object to scene
    scn = bpy.context.scene
    scn.objects.link(rig)
    scn.objects.active = rig
    scn.update()
 
    # Create bones
    
    coefArticulation=.1*coef
    
    bpy.ops.object.editmode_toggle()
    
    spine1 = amt.edit_bones.new('spine1')
    spine1.head = (0,0,8*coef)
    spine1.tail = (-coefArticulation,0,10*coef)
    
    spine2 = amt.edit_bones.new('spine2')
    spine2.head = (-coefArticulation,0,10*coef)
    spine2.tail = (-coefArticulation,0,12*coef)
    spine2.use_connect = True
    spine2.parent = spine1
    
    spine3 = amt.edit_bones.new('spine3')
    spine3.head = (-coefArticulation,0,12*coef)
    spine3.tail = (0,0,14*coef)
    spine3.use_connect = True
    spine3.parent = spine2
    
    neck = amt.edit_bones.new('neck')
    neck.head = (0,0,14*coef)
    neck.tail = (0,0,15*coef)
    neck.use_connect = True
    neck.parent = spine3
    
    head = amt.edit_bones.new('head')
    head.head = (0,0,15*coef)
    head.tail = (0,0,17*coef)
    head.use_connect = True
    head.parent = neck
    
    leftArm = amt.edit_bones.new('leftArm')
    leftArm.head = (0,0,14*coef)
    leftArm.tail = (-coefArticulation,-3*coef,14*coef)
    leftArm.use_connect = True
    leftArm.parent = spine3
    
    leftForearm = amt.edit_bones.new('leftForearm')
    leftForearm.head = (-coefArticulation,-3*coef,14*coef)
    leftForearm.tail = (0,-6*coef,14*coef)
    leftForearm.use_connect = True
    leftForearm.parent = leftArm
    
    leftHand = amt.edit_bones.new('leftHand')
    leftHand.head = (0,-6*coef,14*coef)
    leftHand.tail = (0,-7*coef,14*coef)
    leftHand.use_connect = True
    leftHand.parent = leftForearm
    
    rightArm = amt.edit_bones.new('rightArm')
    rightArm.head = (0,0,14*coef)
    rightArm.tail = (0,3*coef,14*coef)
    rightArm.use_connect = True
    rightArm.parent = spine3
    
    rigthForearm = amt.edit_bones.new('rigthForearm')
    rigthForearm.head = (0,3*coef,14*coef)
    rigthForearm.tail = (0,6*coef,14*coef)
    rigthForearm.use_connect = True
    rigthForearm.parent = rightArm
    
    rightHand = amt.edit_bones.new('rightHand')
    rightHand.head = (0,6*coef,14*coef)
    rightHand.tail = (0,7*coef,14*coef)
    rightHand.use_connect = True
    rightHand.parent = rigthForearm
 
    leftThigh = amt.edit_bones.new('leftThigh')
    leftThigh.head = (0,-1.5*coef,8*coef)
    leftThigh.tail = (coefArticulation,-1.5*coef,4*coef)
    leftThigh.parent = spine1
    
    leftLeg = amt.edit_bones.new('leftLeg')
    leftLeg.head = (coefArticulation,-1.5*coef,4*coef)
    leftLeg.tail = (0,-1.5*coef,0.5*coef)
    leftLeg.use_connect = True
    leftLeg.parent = leftThigh
    
    leftFeet = amt.edit_bones.new('leftFeet')
    leftFeet.head = (0,-1.5*coef,0.5*coef)
    leftFeet.tail = (2*coef,-1.5*coef,0)
    leftFeet.use_connect = True
    leftFeet.parent = leftLeg
 
    rightThigh = amt.edit_bones.new('rightThigh')
    rightThigh.head = (0,1.5*coef,8*coef)
    rightThigh.tail = (coefArticulation,1.5*coef,4*coef)
    rightThigh.parent = spine1
    
    rightLeg = amt.edit_bones.new('rightLeg')
    rightLeg.head = (coefArticulation,1.5*coef,4*coef)
    rightLeg.tail = (0,1.5*coef,0.5*coef)
    rightLeg.use_connect = True
    rightLeg.parent = rightThigh
    
    rightFeet = amt.edit_bones.new('rightFeet')
    rightFeet.head = (0,1.5*coef,0.5*coef)
    rightFeet.tail = (2*coef,1.5*coef,0)
    rightFeet.use_connect = True
    rightFeet.parent = rightLeg
    
    rightLegIK = amt.edit_bones.new('rightLegIK')
    rightLegIK.head = (0,1.5*coef,0.5*coef)
    rightLegIK.tail = (-1.5*coef,1.5*coef,0.5*coef)
    rightLegIK.use_deform = False
    
    leftLegIK = amt.edit_bones.new('leftLegIK')
    leftLegIK.head = (0,-1.5*coef,0.5*coef)
    leftLegIK.tail = (-1.5*coef,-1.5*coef,0.5*coef)
    leftLegIK.use_deform = False
    
    rightKneeIK = amt.edit_bones.new('rightKneeIK')
    rightKneeIK.head = (7*coef,1.5*coef,4*coef)
    rightKneeIK.tail = (7*coef,1.5*coef,7*coef)
    rightKneeIK.use_deform = False
    
    leftKneeIK = amt.edit_bones.new('leftKneeIK')
    leftKneeIK.head = (7*coef,-1.5*coef,4*coef)
    leftKneeIK.tail = (7*coef,-1.5*coef,7*coef)
    leftKneeIK.use_deform = False
    
    rightElbowIK = amt.edit_bones.new('rightElbowIK')
    rightElbowIK.head = (7*coef,3*coef,14*coef)
    rightElbowIK.tail = (7*coef,3*coef,17*coef)
    rightElbowIK.use_deform = False
    
    leftElbowIK = amt.edit_bones.new('leftElbowIK')
    leftElbowIK.head = (7*coef,-3*coef,14*coef)
    leftElbowIK.tail = (7*coef,-3*coef,17*coef)
    leftElbowIK.use_deform = False
    
    rightArmIK = amt.edit_bones.new('rightArmIK')
    rightArmIK.head = (0,7*coef,14*coef)
    rightArmIK.tail = (-1*coef,7*coef,14*coef)
    rightArmIK.use_deform = False
    
    leftArmIK = amt.edit_bones.new('leftArmIK')
    leftArmIK.head = (0,-7*coef,14*coef)
    leftArmIK.tail = (-1*coef,-7*coef,14*coef)
    leftArmIK.use_deform = False
    
    control = amt.edit_bones.new('control')
    control.head = (0,0,0)
    control.tail = (8*coef,0,0)
    control.use_deform = False
    
    bpy.ops.armature.select_all(action='DESELECT')
    rightLegIK.select = True;
    leftLegIK.select = True;
    rightArmIK.select = True;
    leftArmIK.select = True;
    rightKneeIK.select = True;
    leftKneeIK.select = True;
    rightElbowIK.select = True;
    leftElbowIK.select = True;
    spine1.select = True;
    amt.edit_bones.active=control;
    bpy.ops.armature.parent_set(type='OFFSET')
    
    """bpy.ops.armature.select_all(action='DESELECT')
    rightFeet.select = True;
    amt.edit_bones.active=rightLegIK;
    bpy.ops.armature.parent_set(type='OFFSET')
    
    bpy.ops.armature.select_all(action='DESELECT')
    leftFeet.select = True;
    amt.edit_bones.active=leftLegIK;
    bpy.ops.armature.parent_set(type='OFFSET')"""
    
    bpy.ops.object.mode_set(mode='POSE')
    
    bpy.ops.pose.select_all(action='DESELECT')
    bpy.context.object.pose.bones['leftArmIK'].bone.select = True
    bpy.context.object.data.bones.active = bpy.context.object.data.bones['leftHand']
    bpy.ops.pose.constraint_add_with_targets(type='IK')
    cons = bpy.context.object.pose.bones["leftHand"].constraints["IK"]
    cons.chain_count=3
    cons.pole_target=bpy.data.objects["rig"]
    cons.pole_subtarget = "leftElbowIK"
    
    bpy.ops.pose.select_all(action='DESELECT')
    bpy.context.object.pose.bones['rightArmIK'].bone.select = True
    bpy.context.object.data.bones.active = bpy.context.object.data.bones['rightHand']
    bpy.ops.pose.constraint_add_with_targets(type='IK')
    cons = bpy.context.object.pose.bones["rightHand"].constraints["IK"]
    cons.chain_count=3
    cons.pole_target=bpy.data.objects["rig"]
    cons.pole_subtarget = "rightElbowIK"
    
    bpy.ops.pose.select_all(action='DESELECT')
    bpy.context.object.pose.bones['leftLegIK'].bone.select = True
    bpy.context.object.data.bones.active = bpy.context.object.data.bones['leftLeg']
    bpy.ops.pose.constraint_add_with_targets(type='IK')
    cons = bpy.context.object.pose.bones["leftLeg"].constraints["IK"]
    cons.chain_count=2
    cons.pole_target=bpy.data.objects["rig"]
    cons.pole_subtarget = "leftKneeIK"
    
    bpy.ops.pose.select_all(action='DESELECT')
    bpy.context.object.pose.bones['rightLegIK'].bone.select = True
    bpy.context.object.data.bones.active = bpy.context.object.data.bones['rightLeg']
    bpy.ops.pose.constraint_add_with_targets(type='IK')
    cons = bpy.context.object.pose.bones["rightLeg"].constraints["IK"]
    cons.chain_count=2
    cons.pole_target=bpy.data.objects["rig"]
    cons.pole_subtarget = "rightKneeIK"
    
    bpy.context.scene.layers[1]=True
    bpy.context.scene.layers[0]=False
    bpy.ops.object.mode_set(mode='OBJECT')
    bpy.ops.object.select_all(action='SELECT')
    bpy.ops.object.delete(use_global=False)
    bpy.ops.mesh.primitive_torus_add(rotation=(0, 0, 0), view_align=False, location=(0, 0, 0), major_radius=coef*4, minor_radius=.2*coef)
    bpy.context.selected_objects[0].name="MyTorus"
    bpy.ops.mesh.primitive_uv_sphere_add(size=coef, location=(0, 0, 0))
    bpy.context.selected_objects[0].name="MySphere"
    bpy.context.scene.layers[0]=True
    bpy.context.scene.layers[1]=False
    
    #amt.select=True
    bpy.context.scene.objects.active = bpy.data.objects['rig']
    bpy.ops.object.mode_set(mode='POSE')
    bpy.context.object.pose.bones["control"].custom_shape = bpy.data.objects["MyTorus"]
    bpy.context.object.pose.bones["rightKneeIK"].custom_shape = bpy.data.objects["MySphere"]
    bpy.context.object.pose.bones["rightElbowIK"].custom_shape = bpy.data.objects["MySphere"]
    bpy.context.object.pose.bones["leftKneeIK"].custom_shape = bpy.data.objects["MySphere"]
    bpy.context.object.pose.bones["leftElbowIK"].custom_shape = bpy.data.objects["MySphere"]

    bpy.ops.object.mode_set(mode='OBJECT')
    return rig

def placerBalise():
    if nbPlacer < nbBalise:
        bpy.ops.mesh.primitive_uv_sphere_add(size=1, location=(0, 0, 0))
        bpy.ops.object.modal_operator('INVOKE_DEFAULT')
        nbPlacer+=1
        
def placerBalise():
    bpy.ops.object.modal_operator('INVOKE_DEFAULT')
        
def positionView():
    for area in bpy.context.screen.areas:
        if area.type == 'VIEW_3D':
            for region in area.regions:
                if region.type == 'WINDOW':
                    area3D = area
                    area3D.spaces[0].region_3d.view_perspective = 'ORTHO'
                    override = {'area': area, 'region': region, 'edit_object': bpy.context.edit_object}
                    bpy.ops.view3d.viewnumpad(override, type = 'RIGHT')
                    

if __name__ == "__main__":
    #bpy.ops.wm.mouse_position('INVOKE_DEFAULT')
    
    print